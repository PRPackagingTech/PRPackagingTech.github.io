<html>
<head>
    <title>Design Box</title>

    <style>
    	body{
    		margin: 0;
    		overflow: hidden;
    	}
    </style>
</head>
<body>
<div style="width:10%; height:100%; float:left;"></div>
<div style="width:80%; height:100%; float:left;">
    <canvas id="myCanvas"></canvas>
    <canvas id="faceCanvas" style="width:512px; height:512px;"></canvas>
    <canvas id="uvMapCanvas" style="width:512px; height:512px;"></canvas>

    <script src="../Javascript/three.js"></script>
		<script src="..\Javascript\orbitControls.js"></script>

    <script>

    //console.log(faces[0][0][0].name);

    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2;

    var renderer,
    	scene,
    	camera,
    	myCanvas = document.getElementById('myCanvas');

    //RENDERER
    renderer = new THREE.WebGLRenderer({
      canvas: myCanvas,
      antialias: true
    });
    renderer.setClearColor(0x000000);
    renderer.setPixelRatio(window.devicePixelRatio);
    //Change this back or to suit screen size later
    // renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setSize(window.innerWidth/2, window.innerHeight/2);

    //CAMERA
    camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 1000 );
    camera.position.set(5,2.5,2.5);

    //SCENE
    scene = new THREE.Scene();

    //LIGHTS
    var light = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(light);

    var light2 = new THREE.PointLight(0xffffff, 0.5);
    scene.add(light2);

    //controls
    controls = new THREE.OrbitControls(camera, renderer.domElement);

    //MODEL and MODE and FACESELECTED
    var modelType = 0;
    var modeType = 0;
    var faceSelected = 0;

    //LOAD MODEL
    var loader = new THREE.JSONLoader();
    loader.load('../Models/0215closed.json', handle_load);
    loader.load('../Models/0215open.json', handle_load);
    loader.load('../Models/0215.json', handle_load);

    //LOAD TEXTURES
    var textures = [];
    textures.push(new THREE.TextureLoader().load("../Images/0215closedv2.png"));
    textures.push(new THREE.TextureLoader().load("../Images/0215openv2.png"));
    textures.push(new THREE.TextureLoader().load("../Images/0215v4.png"));

    //New face textures
    var newTextures = [];
    newTextures.push(new THREE.TextureLoader().load("../Images/0215closedv2.png"));
    newTextures.push(new THREE.TextureLoader().load("../Images/0215openv2.png"));
    newTextures.push(new THREE.TextureLoader().load("../Images/0215v4.png"));

    //clean up
    var materials = [];

    for(var i = 0; i < 3; i++)
    {
      materials.push(new THREE.MeshLambertMaterial({map: textures[i], transparent: true, opacity: 1, side: THREE.DoubleSide}));
    }

    var mesh = [];

    function handle_load(geometry) {

        //BASIC MESH
        //var material = new THREE.MeshNormalMaterial(materials);

        mesh.push(new THREE.Mesh(geometry, materials[mesh.length]));

        scene.add(mesh[mesh.length - 1]);
        mesh[mesh.length - 1].position.z = 0;
        mesh[mesh.length - 1].scale.set(1, 1, 1);

        if(mesh[(modeType + 1) % 3] != null) mesh[(modeType + 1) % 3].visible = false;
        if(mesh[(modeType + 2) % 3] != null) mesh[(modeType + 2) % 3].visible = false;

    }

    //Generate face for updating
    var canvasF = document.getElementById("faceCanvas");
    canvasF.width = 1024;
    canvasF.height = 1024;
    var ctxF = canvasF.getContext("2d");

    //Generate image for texture map
    var image = new Image(); //Line155
    var updateMaterials = [false, false, false];

    var canvasM = document.getElementById("uvMapCanvas");
    canvasM.width = 1024;
    canvasM.height = 1024;
    var ctxM = canvasM.getContext("2d");

    textures[modeType].image.onload = function(){
      ctxM.drawImage(this, 0, 0);
      drawOnAFace(faceSelected);
    }

    function orientate(){
      ctxF.fillStyle = "black";
      ctxF.fillRect(0, 0, 100, 100);

      ctxF.fillStyle = "#b3b3b3";
      ctxF.fillRect(canvasF.width - 100, 0, 100, 100);

      ctxF.fillStyle = "#4d4d4d";
      ctxF.fillRect(0, canvasF.height - 100, 100, 100);

      ctxF.fillStyle = "white";
      ctxF.fillRect(canvasF.width - 100, canvasF.height - 100, 100, 100);
    }

    function drawOnAFace(faceNum){
      faceSelected = faceNum;
      ctxF.drawImage(newTextures[modeType].image, faces[modelType][modeType][faceSelected].sx, faces[modelType][modeType][faceSelected].sy, faces[modelType][modeType][faceSelected].sWidth, faces[modelType][modeType][faceSelected].sHeight, 0, 0, canvasF.width, canvasF.height);
    }

    function addToTextureMap(){
      ctxM.drawImage(canvasF, 0, 0, canvasF.width, canvasF.height, faces[modelType][modeType][faceSelected].sx, faces[modelType][modeType][faceSelected].sy, faces[modelType][modeType][faceSelected].sWidth, faces[modelType][modeType][faceSelected].sHeight)
      updateTextureMap();
    }

    function updateTextureMap(){
      image.src = canvasM.toDataURL();
      newTextures[modeType] = new THREE.TextureLoader().load(image.src);
      updateMaterials[modeType] = true;
    }

    //

    //RENDER LOOP
    render();

    //var frame = 0;

    function render() {

      controls.update();

      for(var i = 0; i < mesh.length; i++){
        if(updateMaterials[i]){
          materials[i].map = newTextures[i];
          materials[i].needsUpdate = true;
        }
      }

      /*frame++;

      if(frame > 120)
      {
        material1.map = texture1;
        material1.needsUpdate = true;
      }
      if(frame > 240)
      {
        material1.map = texture2;
        material1.needsUpdate = true;
        frame = 0;
      }*/

    	requestAnimationFrame(render);

    	renderer.render(scene, camera);
    }

    </script>
    <script src="..\Javascript\faceDetails.js"></script>
  </div>
  <div style="width:10%; height:100%; float:right;">
    <button type="button" onclick="changeMode(0)" style="width:100%">Close Box</button>
    <button type="button" onclick="changeMode(1)" style="width:100%">Open Box</button>
    <button type="button" onclick="changeMode(2)" style="width:100%">Flatten Box</button>
    <button type="button" onclick="orientate()" style="width:100%">Orientate</button>
    <button type="button" onclick="drawOnAFace(0)" style="width:33.3%">Draw On Top</button>
    <button type="button" onclick="drawOnAFace(1)" style="width:33.3%">Draw On Left</button>
    <button type="button" onclick="drawOnAFace(2)" style="width:33.3%">Draw On Right</button>
    <button type="button" onclick="drawOnAFace(3)" style="width:33.3%">Draw On Front</button>
    <button type="button" onclick="drawOnAFace(4)" style="width:33.3%">Draw On Back</button>
    <button type="button" onclick="drawOnAFace(5)" style="width:33.3%">Draw On Bottom</button>
    <button type="button" onclick="addToTextureMap()" style="width:100%">Add To Texture Map</button>

    <script>
      function changeMode(mode){
        modeType = mode;

        for(var i = 0; i < mesh.length; i++){
          if(i == modeType) mesh[i].visible = true;
          else mesh[i].visible = false;
        }

        ctxM.drawImage(newTextures[modeType].image, 0, 0);
      }
    </script>
  </div>
</body>
</html>
